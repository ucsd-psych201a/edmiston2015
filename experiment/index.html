<!DOCTYPE html>
<html>
 <head>
    <title> Words Special Experiment</title>
    <script src="https://unpkg.com/jspsych@8.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/jspsych@latest/jspsych.js"></script>
 </head>
 <body>
 </body>
 <script>


var jsPsych = initJsPsych({
    on_finish: function() {
        //jsPsych.data.displayData();
        jsPsych.data.get().localSave(‘csv’, ‘experiment_data.csv’);
    }
});

//create timeline
var timeline = [];

// list all stims to use
const IMAGE_PATH_LIST = [
    'stimuli/pictures/bird_hawk_1.jpg', 
    'stimuli/pictures/bird_hawk_2.jpg',
    'stimuli/pictures/bird_song_1.jpg',
    'stimuli/pictures/bird_song_2.jpg',
    'stimuli/pictures/dog_rott_1.jpg',
    'stimuli/pictures/dog_rott_2.jpg',
    'stimuli/pictures/dog_york_1.jpg',
    'stimuli/pictures/dog_york_2.jpg',
    'stimuli/pictures/drum_bongo_1.jpg',
    'stimuli/pictures/drum_bongo_2.jpg',
    'stimuli/pictures/drum_kit_1.jpg',
    'stimuli/pictures/drum_kit_2.jpg',
    'stimuli/pictures/guitar_acoustic_1.jpg', 
    'stimuli/pictures/guitar_acoustic_2.jpg',
    'stimuli/pictures/guitar_electric_1.jpg',
    'stimuli/pictures/guitar_electric_2.jpg',
    'stimuli/pictures/motor_dirt_1.jpg',
    'stimuli/pictures/motor_dirt_2.jpg', 
    'stimuli/pictures/motor_harley_1.jpg', 
    'stimuli/pictures/motor_harley_2.jpg', 
    'stimuli/pictures/phone_cell_1.jpg',
    'stimuli/pictures/phone_cell_2.jpg',
    'stimuli/pictures/phone_rotary_1.jpg',
    'stimuli/pictures/phone_rotary_2.jpg'];

const SOUND_PATH_LIST = [
    'stimuli/sounds/bird_label_A.wav',
    'stimuli/sounds/bird_label_B.wav', 
    'stimuli/sounds/bird_sound_A.wav', 
    'stimuli/sounds/bird_sound_B.wav',
    'stimuli/sounds/bleep.wav', // these may be an issue
    'stimuli/sounds/buzz.wav', // we might have an issue with this
    'stimuli/sounds/dog_label_A.wav', 
    'stimuli/sounds/dog_label_B.wav',
    'stimuli/sounds/dog_sound_A.wav', 
    'stimuli/sounds/dog_sound_B.wav',
    'stimuli/sounds/drum_label_A.wav',
    'stimuli/sounds/drum_label_B.wav',
    'stimuli/sounds/drum_sound_A.wav',
    'stimuli/sounds/drum_sound_B.wav',
    'stimuli/sounds/guitar_label_A.wav',
    'stimuli/sounds/guitar_label_B.wav',
    'stimuli/sounds/guitar_sound_A.wav',
    'stimuli/sounds/guitar_sound_B.wav',
    'stimuli/sounds/motor_label_A.wav',
    'stimuli/sounds/motor_label_B.wav',
    'stimuli/sounds/motor_sound_A.wav', 
    'stimuli/sounds/motor_sound_B.wav',
    'stimuli/sounds/phone_label_A.wav',
    'stimuli/sounds/phone_label_B.wav',
    'stimuli/sounds/phone_sound_A.wav',
    'stimuli/sounds/phone_sound_B.wav'];


//preloaded all images from stimuli folder  
var preload = {
  type: jsPsychPreload,
  images: IMAGE_PATH_LIST, 
  audio: SOUND_PATH_LIST
};
timeline.push(preload); 


//define welcome message trial 
var welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "Welcome to the experiment. We recommend completing these trials in a quiet setting. Headphones are strongly recommended. Press any key to begin."
};
// add the welcome trial to the timeline variable
timeline.push(welcome);

//instructions
// Instructions
const instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `<h2>Instructions</h2>
               <p>Your task is to decide as quickly and accurately as possible if auditory cue you hear matches the image you see.</p>
               <p> First you will hear an auditory cue, then you will see an image. </p>
               <p>Press letter "Y", yes if it matches the image you saw, and letter "N", no if it does not.</p>`,
    choices: ['Start Practice'],
    button_html: ['<button class="jspsych-btn">%choice%</button>']

};

// add instructions to timeline variable 
 timeline.push(instructions);

/**
 * The following are functions defined to load stimuli
 */

// function for loading the correct stims
function create_cue_to_play(cue_name) {
    /**
     * @param {string} cue_name - the auditory/label cue to play
     */ 
    // modified from Jenna's code
    var sound = {
        type:jsPsychAudioButtonResponse,
        stimulus: `stimuli/sounds/${cue_name}.wav`, 
        choices: [], //Do not add choices here, we don't want the participant to respond until after image. Need this line for code to run. 
        trial_ends_after_audio: true // Ends trial automatically after audio finishes
    };
    return sound;
}

// function for loading the correct stims
function create_img_display(img_name, correct_response) {
    /**
     * @param {string} img_name - the picture to show
     */ 
    // modified from Jenna's code
    var img = {
        type: jsPsychImageKeyboardResponse,
        stimulus: `stimuli/pictures/${img_name}.jpg`,
        choices: ['y', 'n'],
        prompt: "Does this image match the auditory cue? Press letter <strong> Y </strong> for yes, letter <strong> N </strong> for no.",
        response_ends_trial: true, // Keeps image visible until response
        data: { correct_response: correct_response }
    };
    return img;
}

function determine_correct_response(cue_name, img_name) {
    const cue_category = cue_name.split('_')[0];
    const img_category = img_name.split('_')[0];
    return cue_category === img_category ? 'y' : 'n';
}

function process_all_imgs() {
    /**
     * This is to load all categories to be tested (bird, dog...)
     * for each image, we want to have its category, subtype, and version number
     */
    // firstly, get all images
    var jpg_files = IMAGE_PATH_LIST.map(path => path.split('/').pop())

    // then parse the jpg file name: catgeory, subtype and version
    var parsed = jpg_files.map(file => {
        var fname = file.substring(0, file.lastIndexOf('.'));
        var [category, subtype, version] = fname.split('_');
        return {
          fname: fname,
          category: category,
          subtype: subtype,
          version: version
        };
    });

    return parsed;
}

// Parse sound details, excluding bleep and buzz
function process_all_sounds() {
    var parsed = SOUND_PATH_LIST
        .filter(path => !path.includes('bleep') && !path.includes('buzz')) // MODIFICATION: Exclude bleep and buzz sounds
        .map(path => {
            var file = path.split('/').pop();
            var fname = file.substring(0, file.lastIndexOf('.'));
            var [category, subtype, version] = fname.split('_');
            return {
                fname: fname,
                category: category,
                subtype: subtype,
                version: version
            };
        });

    return parsed;
}

// collect all images/categories to test
const all_img_stims = process_all_imgs();
const all_sound_stims = process_all_sounds();

// Fixation cross trial
const fixation_cross = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: '<div style="font-size: 48px;">+</div>', // You can change the symbol or style as needed
    choices: "NO_KEYS", // Prevents any key from being pressed
    trial_duration: 250 // Display for 250 ms
};
// Delay trial of 1000 ms (1 second) after audio ends
const delay = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: '', // Blank screen
    choices: "NO_KEYS", // Prevents any response
    trial_duration: 1000 // 1-second delay
};

// Feedback trial
const feedback_trial = {
    type: jsPsychAudioButtonResponse,
    stimulus: function() {
        var last_trial_correct = jsPsych.data.get().last(1).values()[0].response === 
                                 jsPsych.data.get().last(1).values()[0].correct_response;
        return last_trial_correct ? 'stimuli/sounds/bleep.wav' : 'stimuli/sounds/buzz.wav';
    },
    choices: [],
    trial_ends_after_audio: true
};

// Helper function to create Y (match) and N (mismatch) trials
function create_trial(img, sound, correct_response) {
    let cue = {
        type: jsPsychAudioButtonResponse,
        stimulus: `stimuli/sounds/${sound}.wav`,
        choices: [],
        trial_ends_after_audio: true
    };
    let img_display = {
        type: jsPsychImageKeyboardResponse,
        stimulus: `stimuli/pictures/${img}.jpg`,
        choices: ['y', 'n'],
        prompt: "Does this image match the auditory cue? Press Y for yes, N for no.",
        data: { correct_response: correct_response }
    };
    return [fixation_cross, cue, delay, img_display, feedback_trial];
}

// Generate "Y trials" and "N trials"
function generate_trials(N_trials) {
    var trials = [];
    let yes_trial_repeat = 2;

    // Generate 96 "Y trials" for each category and duplicate once for 192 trials
    all_img_stims.forEach(img => {
        let match_sounds = all_sound_stims.filter(sound => sound.category === img.category);
        match_sounds.forEach(sound => {
            for (let i=0;i<yes_trial_repeat;i++) {
                // safer way to repeat (than using jsPsych.randomization.repeat)
                let new_trial = create_trial(img.fname, sound.fname, 'y');
                console.log(sound.fname);
                trials.push(new_trial);
            }
        });
    });

    // Generate 192 "N trials" with mismatching categories
    for (let i = 0; i < 192; i++) {
        let img = jsPsych.randomization.sampleWithoutReplacement(all_img_stims, 1)[0];
        let mismatch_sounds = all_sound_stims.filter(sound => sound.category !== img.category);
        let sound = jsPsych.randomization.sampleWithoutReplacement(mismatch_sounds, 1)[0];
        let new_trial = create_trial(img.fname, sound.fname, 'n'); 
        trials.push(new_trial);
    }

    // shuffle
    trials = jsPsych.randomization.shuffle(trials);

    // select the first N_trials
    trials = trials.slice(0, N_trials);

    // flatten: create one big list
    trials = trials.flat();
    
    return trials;
}

const N_TRIALS = 5; // DEBUG this is for debugging; should be change back to 384 in actual experiment
const trials = generate_trials(N_TRIALS);
timeline.push(...trials);

// osf data pipeline
const subject_id = jsPsych.randomization.randomID(10);
const filename = `${subject_id}.csv`;

const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "ubx08eg1SvJC",
    filename: filename,
    data_string: ()=>jsPsych.data.get().csv()
};

timeline.push(save_data);


// Start the experiment
jsPsych.run(timeline);

</script>
</html>
